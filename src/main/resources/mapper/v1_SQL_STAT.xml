<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.spring_jpa.data.GuriSQL_STAT">

    <!-- 양이 순위 통계 -->
    <select id="yangiRankList" resultType="map" >
          WITH YES_STAT AS (
      		 SELECT    AA.VILLAGE_ID
      		     , AA.VILLAGE_NAME
      		     , AA.KILL_YANG AS YES_KILL
      		     , ROW_NUMBER() OVER (ORDER BY AA.KILL_YANG DESC,cast(AA.VILLAGE_ID as signed) ASC) AS YES_RANK
       FROM
	       (  SELECT
			         	  A.VILLAGE_ID
			         	  , A.VILLAGE_NAME
			         	, IFNULL (SUM(B.KILL_YANG),0) KILL_YANG
			        FROM ( SELECT * FROM kf99.TB_VILLAGE WHERE DEL_YN = 'N' ) A LEFT OUTER JOIN ( SELECT * FROM kf99.TT_YANG_WAR_INFO WHERE STR_TO_DATE(STAT_HH_STND,'%Y%m%d%H%i%s') BETWEEN  ADDDATE( CURDATE(), - WEEKDAY(CURDATE()) + 0 ) AND ADDDATE( CURDATE(), - WEEKDAY(CURDATE()) + 6 ) ) B
			        ON A.VILLAGE_ID = B.VILLAGE_ID
			        WHERE 1=1
			          AND A.VILLAGE_STAT_TYPE  <![CDATA[<>]]> 'VSCD3'
			       GROUP BY A.VILLAGE_ID
	       ) AA
       ),
        BYES_STAT AS (
       		 SELECT    AA.VILLAGE_ID
      		     , AA.KILL_YANG AS BYES_KILL
      		     , ROW_NUMBER() OVER (ORDER BY AA.KILL_YANG DESC,cast(AA.VILLAGE_ID as signed) ASC) AS BYES_RANK
       		  FROM
	       		(  SELECT
			         	  A.VILLAGE_ID
			         	, IFNULL (SUM(B.KILL_YANG),0) KILL_YANG
			        FROM ( SELECT * FROM kf99.TB_VILLAGE WHERE DEL_YN = 'N' ) A LEFT OUTER JOIN ( SELECT * FROM kf99.TT_YANG_WAR_INFO WHERE STR_TO_DATE(STAT_HH_STND,'%Y%m%d%H%i%s') BETWEEN  ADDDATE( CURDATE(), - WEEKDAY(CURDATE())  -7 ) AND ADDDATE( CURDATE(), - WEEKDAY(CURDATE()) + 6 -7) ) B
			        ON A.VILLAGE_ID = B.VILLAGE_ID
			        WHERE 1=1
			          AND A.VILLAGE_STAT_TYPE <![CDATA[<>]]> 'VSCD3'
			       GROUP BY A.VILLAGE_ID
	      	 ) AA
       )
       SELECT AA.*
          FROM (
			  SELECT A.VILLAGE_ID
				   , A.YES_KILL
				   , A.VILLAGE_NAME
				   , B.BYES_KILL
				   , A.YES_RANK
				   , B.BYES_RANK
				   , CASE WHEN ( cast(A.YES_RANK AS signed) - cast(B.BYES_RANK AS signed) ) <![CDATA[<]]> 0 THEN 'UP'
						  WHEN ( cast(A.YES_RANK AS signed) - cast(B.BYES_RANK AS signed) ) <![CDATA[>]]> 0 THEN 'DOWN'
						  ELSE 'NORMAL'
						  END DIFF_TYPE
				   , ABS( cast(A.YES_RANK AS signed) - cast(B.BYES_RANK AS signed))  DIFF_NUM
				   ,  CONCAT( DATE_FORMAT  ( ADDDATE( CURDATE(), - WEEKDAY(CURDATE()) + 0 ), '%m%d'), ' ~ ' , DATE_FORMAT  ( ADDDATE( CURDATE(), - WEEKDAY(CURDATE()) + 6 ), '%m%d')) AS STAT_DAY
				FROM YES_STAT A LEFT OUTER JOIN BYES_STAT B ON A.VILLAGE_ID = B.VILLAGE_ID
			   WHERE 1=1
			   ORDER BY A.YES_RANK
         ) AA
        LIMIT 15
    </select>

</mapper>
